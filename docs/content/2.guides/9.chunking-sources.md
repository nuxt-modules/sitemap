---
title: Chunking Sources
description: Learn how to chunk large sitemap sources into multiple files for better performance and search engine compliance.
---

When working with large datasets, you may need to split your sitemap sources into multiple files to stay within search engine limits and improve performance.

## Why Use Chunking?

- Search engines have limits on sitemap file size (50MB) and URL count (50,000)
- Large sitemaps can be slow to generate and parse
- Chunked sitemaps are easier to debug and manage
- Better performance for both generation and crawling
- Prevents memory issues with extremely large datasets

## Basic Configuration

Enable chunking for any named sitemap that has sources:

```ts
export default defineNuxtConfig({
  sitemap: {
    sitemaps: {
      posts: {
        sources: ['/api/posts'],
        chunks: true, // Enable chunking with default size
      }
    }
  }
})
```

## Chunk Size Configuration

You can specify chunk sizes in multiple ways:

```ts
export default defineNuxtConfig({
  sitemap: {
    // Global default chunk size
    defaultSitemapsChunkSize: 5000,
    
    sitemaps: {
      // Option 1: Boolean (uses defaultSitemapsChunkSize)
      posts: {
        sources: ['/api/posts'],
        chunks: true, // Uses default: 1000 or defaultSitemapsChunkSize
      },
      
      // Option 2: Number as chunk size
      products: {
        sources: ['/api/products'],
        chunks: 5000, // 5000 URLs per chunk
      },
      
      // Option 3: Explicit chunkSize (takes precedence)
      articles: {
        sources: ['/api/articles'],
        chunks: true,
        chunkSize: 2000, // Takes precedence over chunks value
      }
    }
  }
})
```

### Precedence Rules

1. `chunkSize` property takes highest precedence
2. `chunks` number value is used if `chunkSize` not specified
3. `defaultSitemapsChunkSize` is used if `chunks: true`
4. Default is 1000 if no configuration provided

## Real-World Examples

### E-commerce Site

```ts
export default defineNuxtConfig({
  sitemap: {
    defaultSitemapsChunkSize: 10000,
    sitemaps: {
      // Product catalog with 100,000+ items
      products: {
        sources: ['/api/products/all'],
        chunks: 10000, // Split into 10k chunks
        defaults: {
          changefreq: 'weekly',
          priority: 0.8
        }
      },
      // Categories with fewer items
      categories: {
        sources: ['/api/categories'],
        chunks: true, // Uses default 10k
        defaults: {
          changefreq: 'monthly',
          priority: 0.9
        }
      },
      // Regular pages without chunking
      pages: {
        includeAppSources: true,
        exclude: ['/products/**', '/categories/**']
      }
    }
  }
})
```

### Blog/Content Site

```ts
export default defineNuxtConfig({
  sitemap: {
    sitemaps: {
      // Thousands of blog posts
      'blog-posts': {
        sources: ['/api/blog/posts'],
        chunks: 5000,
        defaults: {
          changefreq: 'weekly',
          priority: 0.7
        }
      },
      // Author pages
      authors: {
        sources: ['/api/authors'],
        chunks: false, // Explicitly disable chunking
      },
      // News articles with date-based chunking
      news: {
        sources: [
          '/api/news/2024',
          '/api/news/2023'
        ],
        chunks: 2500,
      }
    }
  }
})
```

## Generated Files

When chunking is enabled, the module generates:

```
/sitemap_index.xml      # Master index including all chunks
/products-0.xml         # First chunk (URLs 1-10,000)
/products-1.xml         # Second chunk (URLs 10,001-20,000)
/products-2.xml         # Third chunk (URLs 20,001-30,000)
...
/blog-posts-0.xml       # First chunk (URLs 1-5,000)
/blog-posts-1.xml       # Second chunk (URLs 5,001-10,000)
...
/pages.xml              # Regular sitemap without chunking
```

## API Implementation

### Basic Source Endpoint

```ts [server/api/products/all.ts]
export default defineEventHandler(async () => {
  const products = await db.products.findAll({
    select: ['id', 'slug', 'updatedAt', 'images']
  })
  
  return products.map(product => ({
    loc: `/products/${product.slug}`,
    lastmod: product.updatedAt,
    images: product.images?.map(img => ({
      loc: img.url,
      title: img.alt
    }))
  }))
})
```

### Optimized for Large Datasets

```ts [server/api/products/all.ts]
export default defineCachedEventHandler(async () => {
  // Use streaming/cursor for very large datasets
  const products = []
  const cursor = db.products.cursor({
    select: ['slug', 'updatedAt']
  })
  
  for await (const product of cursor) {
    products.push({
      loc: `/products/${product.slug}`,
      lastmod: product.updatedAt
    })
  }
  
  return products
}, {
  maxAge: 60 * 60, // Cache for 1 hour
  name: 'sitemap-products',
  getKey: () => 'all'
})
```

## Important Notes

### What Gets Chunked

- **Sources**: URLs from API endpoints are chunked
- **Direct URLs**: URLs specified in the `urls` property are NOT chunked
- **Mixed**: When using both, only source URLs are chunked

```ts
export default defineNuxtConfig({
  sitemap: {
    sitemaps: {
      mixed: {
        urls: ['/page-1', '/page-2'], // These stay in main sitemap
        sources: ['/api/dynamic'],    // These get chunked
        chunks: true
      }
    }
  }
})
```

### Edge Cases

1. **Empty Sources**: No chunks are created for empty sources
2. **Single URL**: Creates one chunk with one URL
3. **Exact Division**: 10 URLs with chunkSize: 5 creates exactly 2 chunks
4. **Invalid Values**: Negative numbers or zero are ignored

### Performance Considerations

1. **Memory Usage**: Chunks help manage memory for large datasets
2. **Generation Time**: Chunks are generated on-demand, not all at once
3. **Caching**: Each chunk is cached independently
4. **Source Fetching**: Sources are fetched once and shared across chunks

## Debugging

Enable debug mode to inspect chunking behavior:

```ts
export default defineNuxtConfig({
  sitemap: {
    debug: true,
    sitemaps: {
      products: {
        sources: ['/api/products'],
        chunks: 5000
      }
    }
  }
})
```

Visit `/__sitemap__/debug.json` to see:
- Chunk configuration details
- Number of chunks generated
- URLs per chunk
- Source fetch timing

### Debug Output Example

```json
{
  "sitemaps": {
    "products": {
      "chunks": 5000,
      "_isChunking": true,
      "_chunkSize": 5000,
      "_chunkCount": 3,
      "sources": [
        {
          "fetch": "/api/products",
          "urls": 12500,
          "timeTakenMs": 234
        }
      ]
    }
  }
}
```

## Best Practices

1. **Choose Appropriate Chunk Sizes**
   - Consider your server's memory limits
   - Balance between file size and number of files
   - Stay well below the 50k URL limit (recommend 10-25k)

2. **Optimize Source Endpoints**
   - Return only necessary fields for sitemaps
   - Use database indexes for sorting
   - Implement caching for expensive queries

3. **Monitor Performance**
   - Track generation times
   - Monitor memory usage
   - Check crawler access patterns

4. **Error Handling**
   - Sources that fail won't break chunking
   - Empty chunks are handled gracefully
   - Invalid configurations fall back to defaults

## Migration Guide

If you're upgrading from a non-chunked setup:

```ts
// Before
export default defineNuxtConfig({
  sitemap: {
    sources: ['/api/all-urls'] // 100k+ URLs in one file
  }
})

// After
export default defineNuxtConfig({
  sitemap: {
    sitemaps: {
      main: {
        sources: ['/api/all-urls'],
        chunks: 10000 // Split into manageable chunks
      }
    }
  }
})
```